<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Visualizador ODS ‚Äî estilo MAC</title>

<!-- SheetJS: l√™ .ods/.xlsx no navegador -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  /* ===== base / tipografia ===== */
  :root{
    --azul:#007BFF;
    --amarelo:#FFD700;
    --vermelho:#b22222;
    --cinza:#f7fbff;
    --borda:#e5e7eb;
    --texto:#111;
  }
  *{ box-sizing:border-box; }
  html,body{ height:100%; }
  body{
    font-family: monospace;
    margin:0; padding:0;
    -webkit-font-smoothing:antialiased;
    color:var(--texto);
    background:#fff;
  }

  /* ===== header (est√©tica MAC) ===== */
  header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    background:var(--azul);
    color:#fff;
    padding:10px 14px;
    gap:12px;
    position:sticky; top:0; z-index:999;
  }
  .menu-left,.menu-right{ display:flex; gap:8px; align-items:center; }
  .icon-btn{
    background:none; border:none; color:#fff;
    font-size:18px; cursor:pointer;
    padding:6px 8px; border-radius:6px; user-select:none;
  }
  .icon-btn:hover{ background:rgba(255,255,255,.08) }

  /* dropdowns: left menu aligns left, right menu aligns right */
  .menu-dropdown{ position:relative; }
  .menu-left .menu-dropdown-content { left: 0; right: auto; }
  .menu-right .menu-dropdown-content { right: 0; left: auto; }

  .menu-dropdown-content{
    display:none; position:absolute; top:calc(100% + 6px);
    background:#fff; color:#111; border-radius:6px;
    box-shadow:0 6px 18px rgba(0,0,0,.15);
    min-width:190px; overflow:auto; z-index:1200; padding:6px 0;
  }
  .menu-dropdown-content a{
    display:block; padding:8px 12px; color:#111; text-decoration:none;
  }
  .menu-dropdown-content a:hover{ background:#f2f2f2; }

  /* ===== t√≠tulo (sem setas) ===== */
  .titulo-nav{
    display:flex; justify-content:center; align-items:center;
    gap:16px; margin:14px 10px 8px; text-align:center;
  }
  .titulo-nav h1{ margin:0; font-size:18px; color:#111; }

  /* ===== wrapper (usado para escala antes da impress√£o) ===== */
  #main-wrapper.wrap{ max-width:1100px; margin:0 auto; padding:8px 14px 28px; }

  /* ===== uploader (drag & drop) ===== */
  #uploader{ margin-top:8px; }
  .dropzone{
    /* centraliza√ß√£o total do conte√∫do */
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    width:100%;
    border:2px dashed var(--azul);
    border-radius:12px; padding:28px; text-align:center;
    background:var(--cinza); color:#0b305a;
    cursor:pointer; user-select:none; transition:.15s ease;
    min-height:200px;
  }
  .dropzone .title{ font-weight:700; margin-bottom:6px; font-size:14px; }
  .dropzone .hint{ font-size:12px; opacity:.8; }
  .dropzone.dragover{ background:#eef6ff; border-style:solid; transform:scale(1.01); }
  /* input fora da label para evitar di√°logo duplo */
  #file-input{ position:absolute; left:-9999px; width:1px; height:1px; opacity:0; }

  /* ===== viewer ===== */
  #viewer{ display:none; }
  .actions-top{
    display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:10px 0;
  }
  .tabs{
    display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 10px;
  }
  .tab-btn{
    padding:6px 10px; border:1px solid var(--borda); border-radius:6px;
    background:#fff; cursor:pointer; font-family:monospace; font-size:12px;
  }
  .tab-btn.active{ background:#e8f2ff; border-color:#cfe2ff; color:#0b305a; }

  .sheets{
    width:100%; overflow:auto; border:1px solid var(--borda);
    border-radius:8px; background:#fff;
  }
  .sheet{ display:none; padding:12px; }
  .sheet.active{ display:block; }
  .sheet table{
    width:100%; border-collapse:collapse; table-layout:auto; font-size:12px;
  }
  .sheet th,.sheet td{
    border:1px solid #ddd; padding:6px 8px; vertical-align:top; word-break:break-word;
  }
  .sheet thead th{ background:#f9fafb; font-weight:700; }
  .sheet tbody tr:nth-child(even){ background:#fafafa; }

  .viewer-footer{
    margin-top:10px; display:flex; flex-wrap:wrap;
    gap:10px; align-items:center; justify-content:space-between;
  }
  .status{ font-size:12px; color:#333; }
  .btn{
    border:1px solid var(--borda); background:#fff; cursor:pointer;
    padding:8px 12px; border-radius:6px; font-family:monospace; font-size:12px;
  }
  .btn-primaria{ background:#e8f2ff; border-color:#cfe2ff; color:#0b305a; }
  .btn-perigo{ background:var(--vermelho); color:#fff; border:none; }

  /* aviso/Toast (reaproveita o "Copiado!") */
  #copy-notice{
    position: fixed; right: 18px; bottom: 18px;
    background: rgba(0,0,0,0.84); color: white;
    padding: 9px 13px; border-radius: 8px;
    display: none; z-index: 2000; font-size:12px;
  }

  /* ===== impress√£o (estilos gerais) =====
     Observa√ß√£o: a fun√ß√£o JS 'prepareAndPrintSinglePage' aplica escala ao
     #main-wrapper para garantir que tudo caiba em UMA p√°gina.
  */
  @media print{
    header, .menu-dropdown-content, #uploader, #copy-notice, .viewer-footer .btn, .menu-left .icon-btn, .menu-right .icon-btn { display:none !important; }
    body, html { background:#fff; }
    #main-wrapper.wrap{ padding:0 !important; max-width:none !important; margin:0 !important; }
    .sheets{ overflow:visible !important; border:none !important; }
    .sheet{ padding:0 !important; margin:0 !important; }
    .sheet table{ font-size:10px !important; border-collapse:collapse !important; }
    .sheet th, .sheet td{ padding:3px 4px !important; }
    .tabs, .actions-top, .viewer-footer { display:none !important; }
    /* tentativa extra para evitar 2¬™ p√°gina vazia por arredondamentos:
       reduz pequena escala em engines que respeitam zoom (Chrome/Edge). */
    html.print-scaled, body.print-scaled { zoom:0.98; -webkit-print-color-adjust:exact; }
    @page{ size:A4 portrait; margin:10mm; }
  }

  /* classe para esconder elementos enquanto medimos via JS */
  body.preparing-print header,
  body.preparing-print #uploader,
  body.preparing-print .menu-dropdown-content,
  body.preparing-print .tabs,
  body.preparing-print .viewer-footer { display:none !important; }
</style>
</head>
<body>

<header>
  <!-- ESQUERDA -->
  <div class="menu-left">
    <div class="menu-dropdown">
      <button class="icon-btn" title="Menu (‚ò∞)" onclick="toggleMenu('dropdown-menu')">‚ò∞</button>
      <div class="menu-dropdown-content" id="dropdown-menu">
        <a href="#" onclick="showToast('P√°gina 1 (em breve)');return false;">P√°gina 1 (em breve)</a>
        <a href="#" onclick="showToast('P√°gina 2 (em breve)');return false;">P√°gina 2 (em breve)</a>
        <a href="#" onclick="showToast('P√°gina 3 (em breve)');return false;">P√°gina 3 (em breve)</a>
      </div>
    </div>
    <button class="icon-btn" title="Fechar (‚ùå)" onclick="fecharPagina()">‚ùå</button>
    <button class="icon-btn" title="Menu inicial (üè†)" onclick="voltarMenu()">üè†</button>
  </div>

  <!-- DIREITA -->
  <div class="menu-right">
    <div class="menu-dropdown">
      <button class="icon-btn" id="btn-salvar" title="Salvar (üíæ)" onclick="toggleMenu('dropdown-save')">üíæ</button>
      <div class="menu-dropdown-content" id="dropdown-save" aria-labelledby="btn-salvar">
        <a href="#" onclick="exportarXLSX();fecharTodosMenus();return false;">Salvar como XLSX</a>
        <a href="#" onclick="exportarCSVAtivo();fecharTodosMenus();return false;">Salvar CSV (aba ativa)</a>
        <a href="#" onclick="exportarJSON();fecharTodosMenus();return false;">Salvar como JSON</a>
      </div>
    </div>
    <button class="icon-btn" id="btn-print" title="Imprimir (üñ®Ô∏è)" onclick="prepareAndPrintSinglePage()">üñ®Ô∏è</button>
    <button class="icon-btn" id="btn-copy" title="Copiar (üìã)" onclick="copiarTabelaAtiva()">üìã</button>
  </div>
</header>

<!-- T√≠tulo -->
<div class="titulo-nav">
  <h1 id="titulo">Visualizador de Planilhas (.ods)</h1>
</div>

<!-- MAIN WRAPPER: a escala para impress√£o ser√° aplicada aqui -->
<div id="main-wrapper" class="wrap">
  <!-- ===== Uploader ===== -->
  <section id="uploader" aria-label="Carregar planilha">
    <!-- input fora da label para evitar di√°logo duplo -->
    <input id="file-input" type="file" accept=".ods,.xlsx,.xls,.csv" />
    <label class="dropzone" id="dropzone" for="file-input">
      <div class="title">Arraste e solte seu arquivo .ods aqui</div>
      <div class="hint">ou clique nesta √°rea para selecionar do computador</div>
    </label>
  </section>

  <!-- ===== Viewer ===== -->
  <section id="viewer" aria-label="Visualiza√ß√£o da planilha">
    <div class="actions-top">
      <span style="font-size:12px;opacity:.75;">Arquivo: <strong id="nome-arquivo">‚Äî</strong></span>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="sheets" id="sheets"></div>

    <div class="viewer-footer">
      <div class="status" id="status">Pronto.</div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" onclick="exportarCSVAtivo()" title="Salvar CSV da aba atual">Salvar CSV (aba ativa)</button>
        <button class="btn" onclick="exportarXLSX()" title="Salvar arquivo completo em XLSX">Salvar XLSX</button>
        <button class="btn" onclick="exportarJSON()" title="Salvar todas as abas em JSON">Salvar JSON</button>
        <button class="btn btn-primaria" id="btn-outro" onclick="resetViewer()" title="Carregar outro arquivo">Fazer com outro arquivo</button>
      </div>
    </div>
  </section>
</div>

<div id="copy-notice">Copiado!</div>

<script>
/* ========= helpers visuais / toasts ========= */
function showToast(msg){
  const el = document.getElementById('copy-notice');
  el.textContent = msg;
  el.style.display = 'block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=>{ el.style.display='none'; }, 1700);
}
function toggleMenu(id){
  // fecha outros
  document.querySelectorAll('.menu-dropdown-content').forEach(el=>{
    if(el.id !== id){ el.style.display='none'; el.style.opacity=0; }
  });
  const el = document.getElementById(id);
  if(!el) return;
  if(el.style.display==='block'){ el.style.opacity=0; setTimeout(()=>el.style.display='none',180); }
  else{ el.style.display='block'; el.style.opacity=0; setTimeout(()=>el.style.opacity=1,10); }
}
function fecharTodosMenus(){
  document.querySelectorAll('.menu-dropdown-content').forEach(el=>{ el.style.display='none'; el.style.opacity=0; });
}
document.addEventListener('click',(ev)=>{
  if(!ev.target.closest('.menu-dropdown')) fecharTodosMenus();
});
function fecharPagina(){ if(confirm('Fechar a p√°gina? (pode n√£o funcionar em todos navegadores)')){ try{ window.close(); }catch(e){} } }
function voltarMenu(){ showToast('Voltar ao menu (configure o redirecionamento).'); }

/* ========= estado ========= */
let currentWB = null;         // workbook carregado
let currentFileName = null;   // nome do arquivo
let activeSheetName = null;   // aba ativa

/* ========= elementos ========= */
const uploader = document.getElementById('uploader');
const viewer   = document.getElementById('viewer');
const dropzone = document.getElementById('dropzone');
const fileInput= document.getElementById('file-input');
const tabs     = document.getElementById('tabs');
const sheets   = document.getElementById('sheets');
const statusEl = document.getElementById('status');

/* ========= drag & drop / sele√ß√£o ========= */
dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('dragover'); });
dropzone.addEventListener('dragleave', ()=> dropzone.classList.remove('dragover'));
dropzone.addEventListener('drop', (e)=>{
  e.preventDefault(); dropzone.classList.remove('dragover');
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if(f) processFile(f);
});
fileInput.addEventListener('change', (e)=>{
  const f = e.target.files && e.target.files[0];
  if(f) processFile(f);
});

/* ========= processamento ========= */
function processFile(file){
  statusEl.textContent = 'Lendo arquivo...';
  currentFileName = file.name;
  document.getElementById('titulo').textContent = `Visualizador de Planilhas ‚Äî ${currentFileName}`;
  document.getElementById('nome-arquivo').textContent = currentFileName;

  const reader = new FileReader();
  reader.onload = function(evt){
    try{
      const data = new Uint8Array(evt.target.result);
      const wb = XLSX.read(data, { type:'array' }); // suporta .ods/.xlsx
      currentWB = wb;
      renderWorkbook(wb);
      // troca para modo viewer
      uploader.style.display = 'none';
      viewer.style.display   = 'block';
      statusEl.textContent   = `Carregado: ${file.name} (${wb.SheetNames.length} aba${wb.SheetNames.length>1?'s':''})`;
    }catch(err){
      console.error(err);
      statusEl.textContent = 'Erro ao ler o arquivo.';
      showToast('N√£o consegui abrir esse arquivo.');
    }
  };
  reader.onerror = function(){ statusEl.textContent = 'Falha na leitura do arquivo.'; showToast('Falha na leitura do arquivo.'); };
  reader.readAsArrayBuffer(file);
}

function renderWorkbook(wb){
  tabs.innerHTML = '';
  sheets.innerHTML = '';
  sheets.style.display = 'block';
  tabs.style.display   = 'flex';

  wb.SheetNames.forEach((name, idx)=>{
    // cria bot√£o da aba
    const btn = document.createElement('button');
    btn.className = 'tab-btn';
    btn.textContent = name || `Aba ${idx+1}`;
    btn.addEventListener('click', ()=> setActiveSheet(name));
    tabs.appendChild(btn);

    // cria painel da planilha com html do SheetJS
    const ws = wb.Sheets[name];
    const html = XLSX.utils.sheet_to_html(ws, { id:`sheet-${idx}`, header:'', footer:'' });

    const pane = document.createElement('div');
    pane.className = 'sheet';
    pane.dataset.name = name;
    pane.innerHTML = html; // a <table> vem pronta
    sheets.appendChild(pane);
  });

  setActiveSheet(wb.SheetNames[0]);
}

function setActiveSheet(name){
  activeSheetName = name;
  // ativo visual nas abas
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.classList.toggle('active', btn.textContent === name);
  });
  // mostrar/esconder pain√©is
  document.querySelectorAll('.sheet').forEach(p=>{
    p.classList.toggle('active', p.dataset.name === name);
  });
}

/* ========= exporta√ß√µes ========= */
function exportarXLSX(){
  if(!currentWB){ showToast('Nada para salvar.'); return; }
  const nome = (currentFileName || 'planilha') + '.xlsx';
  XLSX.writeFile(currentWB, nome);
  showToast('Baixando XLSX‚Ä¶');
}
function exportarCSVAtivo(){
  if(!currentWB || !activeSheetName){ showToast('Nenhuma aba ativa.'); return; }
  const ws = currentWB.Sheets[activeSheetName];
  const csv = XLSX.utils.sheet_to_csv(ws);
  downloadText(csv, sanitizeFileName(activeSheetName)+'.csv', 'text/csv;charset=utf-8;');
  showToast('CSV gerado.');
}
function exportarJSON(){
  if(!currentWB){ showToast('Nada para salvar.'); return; }
  const out = {};
  currentWB.SheetNames.forEach(name=>{
    const ws = currentWB.Sheets[name];
    out[name] = XLSX.utils.sheet_to_json(ws, { defval:null });
  });
  downloadText(JSON.stringify(out,null,2), (currentFileName||'planilha')+'.json', 'application/json;charset=utf-8;');
  showToast('JSON gerado.');
}
function downloadText(content, filename, type){
  const blob = new Blob([content], { type });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
}
function sanitizeFileName(s){ return (s||'').toString().replace(/[\\/:*?"<>|]+/g,'_').trim() || 'aba'; }

/* ========= copiar ========= */
function copiarTabelaAtiva(){
  if(!activeSheetName || !currentWB){ showToast('Nada para copiar.'); return; }
  const ws = currentWB.Sheets[activeSheetName];
  const tsv = XLSX.utils.sheet_to_csv(ws, { FS:"\t" });
  navigator.clipboard.writeText(tsv).then(()=>showToast('Copiado!')).catch(()=>showToast('N√£o foi poss√≠vel copiar.'));
}

/* ========= impress√£o: escala e impress√£o em 1 p√°gina ========= */
function hasConteudoImprimivel(){
  if(!currentWB) return false;
  const ativa = document.querySelector('.sheet.active table');
  if(!ativa) return false;
  return ativa.querySelector('td,th') !== null;
}

function prepareAndPrintSinglePage(){
  if(!hasConteudoImprimivel()){ showToast('Nada para imprimir.'); return; }

  const body = document.body;
  const wrapper = document.getElementById('main-wrapper');

  // 1) esconder UI desnecess√°ria durante medi√ß√£o
  body.classList.add('preparing-print');

  // 2) criar refer√™ncia A4 em mm para descobrir px
  const mmEl = document.createElement('div');
  mmEl.style.position = 'absolute';
  mmEl.style.left = '-99999px';
  mmEl.style.width = '210mm';
  mmEl.style.height = '297mm';
  document.body.appendChild(mmEl);
  const pagePxW = mmEl.offsetWidth || 210 * 3.78;
  const pagePxH = mmEl.offsetHeight || 297 * 3.78;
  document.body.removeChild(mmEl);

  // margens (deixar coerente com @page)
  const marginMm = 10; // 10mm como no CSS
  const marginPx = Math.round(pagePxW * (marginMm / 210));
  const availW = Math.max(10, pagePxW - marginPx*2);
  const availH = Math.max(10, pagePxH - marginPx*2);

  // 3) reset transform e medir
  const prevTransform = wrapper.style.transform || '';
  const prevTransformOrigin = wrapper.style.transformOrigin || '';
  wrapper.style.transform = '';
  wrapper.style.transformOrigin = '';

  // let layout settle
  setTimeout(()=>{
    const contentW = wrapper.scrollWidth || wrapper.offsetWidth || wrapper.clientWidth;
    const contentH = wrapper.scrollHeight || wrapper.offsetHeight || wrapper.clientHeight;

    const scaleW = contentW > 0 ? (availW / contentW) : 1;
    const scaleH = contentH > 0 ? (availH / contentH) : 1;
    let scale = Math.min(scaleW, scaleH, 1);

    if(!isFinite(scale) || scale <= 0) scale = 1;
    if(scale < 0.30) scale = 0.30; // evita ficar ileg√≠vel

    // aplica escala
    wrapper.style.transformOrigin = 'top left';
    wrapper.style.transform = `scale(${scale})`;

    // marca no html/body que aplicamos escala (ajuda no print CSS)
    document.documentElement.classList.add('print-scaled');
    document.body.classList.add('print-scaled');

    // guarda overflow e evita scrollbars no preview
    const prevOverflow = document.documentElement.style.overflow || '';
    document.documentElement.style.overflow = 'hidden';

    // cleanup
    const cleanup = () => {
      wrapper.style.transform = prevTransform;
      wrapper.style.transformOrigin = prevTransformOrigin;
      body.classList.remove('preparing-print');
      document.documentElement.classList.remove('print-scaled');
      document.body.classList.remove('print-scaled');
      document.documentElement.style.overflow = prevOverflow;
      try{ window.removeEventListener('afterprint', cleanup); }catch(e){}
    };

    // afterprint handler
    try { window.addEventListener('afterprint', cleanup); } catch(e){ /* ignore */ }

    // chama print
    setTimeout(() => {
      window.print();
      // fallback cleanup caso afterprint n√£o dispare
      setTimeout(cleanup, 1500);
    }, 150);

  }, 60);
}

/* ========= reset (fazer com outro) ========= */
function resetViewer(){
  tabs.innerHTML = '';
  sheets.innerHTML = '';
  currentWB = null; activeSheetName = null;
  document.getElementById('nome-arquivo').textContent = '‚Äî';
  document.getElementById('titulo').textContent = 'Visualizador de Planilhas (.ods)';
  statusEl.textContent = 'Pronto.';
  try{ fileInput.value = ''; }catch(e){}
  viewer.style.display = 'none';
  uploader.style.display = 'block';
}

/* ========= acessibilidade/UX ========= */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){ fecharTodosMenus(); }
});
</script>
</body>
</html>
